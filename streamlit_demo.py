#!/usr/bin/env python3
"""
コピージェネレーター
"""

import streamlit as st
import openai
import pandas as pd
from typing import List, Dict
import os

# 固定APIキー設定（環境変数から取得、なければデフォルト値）
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY", "sk-proj-your-api-key-here")

# 20個のコピーライティングテクニック
COPYWRITING_TECHNIQUES = """
以下の20個のテクニックを参考にして、効果的なキャッチコピーを作成してください：

１：意外なファクトに基づいて発見を与える
例：「落書きをやめると、成績は下がる。」「セックスにもソックスを。足元を暖めると、オルガズムに達しやすくなる。」「日本語では、事故で亡くなる。海外ではkillという。」

２：建前を放棄して本音を語る
例：「また売れなかったらどうしよう」「広告規制により、サンマを持たされています」

３：商品価値を最大化して、社会における意味を語る
例：「ロケットも、文房具から生まれた。」「英語を話せると、10億人と話せる」「地図に残る仕事。（建設会社のコピー）」

４：数え方を工夫してみる
例：「日本で４７番目に有名な県」「四十歳は２度目のハタチ。」「１億使っても、まだ２億。」

５：物事を捉える視点を変えてみる
例：「ぼくのお父さんは、桃太郎というやつに殺されました。」（鬼視点）「おしりだって洗ってほしい」（身体視点）「太陽から見れば、日本には広大な空き地が広がっている」（太陽視点）

６：新しい二項対立を作ってみる
例：「ゴリマッチョ。細マッチョ。」「ひたパン、つけパン」「権力より、愛だね」

７：商品がないことによる不便を描く
例：「部長の山本はまもなく戻りますので、そこに座ってろ。（英会話のコピー）」「今、この男のカバンの中では、 水筒のお茶がめちゃくちゃ漏れている。」

８：ほっこりするシーンを切り取る
例：「金魚の便秘なおる。」（水族館のコピー）「もう一回またがってから寝よ。」（バイクのコピー）「スキップしちゃった。」（コージーコーナーのコピー）

９：企業名を人の名前のように使う
例：「なぜつばさを使わないんだ。あなたの資産もそうです。つばさ証券」「楽天カードマン」「新しい英雄、始まる。au」

１０：その時代ならではの社会課題を語る
例：「同性を好きになるのは、じつは左利きと同じくらいいる。」「年をとるだけで、劣化と呼ばれる時代を生きている。」「日本初の女性総理は、きっともう、この世にいる。」

１１：納得できる世の中の法則を伝える
例：「お母さんを育てるのは、赤ちゃんです。」「花を育てるようになると雨が好きになる」「試着室で思い出したら、本気の恋だと思う。」「着物を着ている日は、すこし丁寧に生きている。」

１２：心の声やつぶやきをコピーにする
例：「私だけ、美人だったら、いいのに。」「そうだ　京都、いこう。」「つまらん！」

１３：ターゲットが共感できる想いを代弁してあげる
例：「知名度だけが一流の会社で働くより、知名度だけが二流の会社で働きたい。」「結婚しなくても幸せになれるこの時代に　私は、あなたと結婚したいのです。」「１年が過ぎるのは早いが、１日はなかなか終わらない。」

１４：自虐的に自分自身を語る
例：「ここは、日本一心の距離が遠いサファリパーク」「スイてます嵐山」「その程度の機能ならドンキで十分だ！」

１５：ダジャレにしてみる
例：「バザールでござーる」「でっかいどお。北海道」「ナイフのようなナイーブ。」「あしたのもと 味の素」「カラダにピース。カルピス」

１６：成分のように表現してみる
例：「バファリンの半分はやさしさでできてます。」「おいしいものは、脂肪と糖でできている」「世界は誰かの仕事でできている」

１７：価値を再定義する
例：「年賀状は、贈り物だと思う。」「戦争を４度も経験したジーンズ（古着のコピー）」「チョコが義理なら、アメは人情。」「映画は、本当のことを言う嘘だ。」

１８：効果を伝える
例：「倒れるだけで腹筋」「吸引力が変わらないただ一つの掃除機」「ある日、日経は顔に出る」

１９：ライバルに喧嘩を売る
例：「マヨネーズよ。真似すんなよ。（ケチャップのコピー）」「現金って、奇妙なモノを持ち歩いているもんだ（クレジットカードのコピー）」

２０：常識をひっくり返してみる
例：「地味ハロウィン」「抽選で１名をハズレとする」「健康がブームになるなんて、異常だ。」

【重要な指示】
上記のテクニックを参考に、最も効果的な5個のキャッチコピーのみを出力してください。
各コピーは短く、インパクトがあり、ターゲットに刺さるものにしてください。
テクニック名や番号は表示せず、コピーのみを出力してください。
"""

def generate_copy_ideas(orientation: str, num_ideas: int = 5) -> str:
    """オリエンテーション + テクニックベースのコピー生成"""
    openai.api_key = OPENAI_API_KEY
    
    full_prompt = f"""
{orientation}

{COPYWRITING_TECHNIQUES}

最終的に{num_ideas}個の厳選されたコピーを出力してください。
"""
    
    try:
        response = openai.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system", 
                    "content": """あなたは優秀なコピーライターです。
与えられたオリエンテーション情報と20個のテクニックを活用して、効果的なキャッチコピーを作成してください。

出力は簡潔で、最終選出されたコピーのみを提示してください。"""
                },
                {"role": "user", "content": full_prompt}
            ],
            max_tokens=1200,
            temperature=0.9
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"エラーが発生しました: {str(e)}"

# Streamlit UI
st.set_page_config(
    page_title="コピージェネレーター",
    page_icon="✏️",
    layout="wide"
)

# --- デバッグ情報表示 ---
st.warning(f"""
**【デバッグ情報】** (問題解決後にこの表示は削除します)

現在アプリが読み込んでいるAPIキー:

`{OPENAI_API_KEY[:7]}...{OPENAI_API_KEY[-4:]}`

- **もし `sk-proj-...here` と表示される場合：** Secretsが正しく読み込めていません。Secretsの入力内容（名前が`OPENAI_API_KEY`か、保存が完了しているか）を再確認してください。
- **もしご自身のキーの最初と最後が表示される場合：** キーの読み込みは成功しています。問題はOpenAIアカウント側（支払設定の未完了、キーの無効化など）にある可能性が高いです。
""")
# --- デバッグ情報表示終了 ---

st.markdown("---")

# メインエリア
col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("📋 オリエンテーション入力")
    
    # オリエンテーション入力エリア
    orientation = st.text_area(
        "企業情報・課題・ターゲット等を入力してください",
        placeholder="""例：
課題のポイント
今回、募集する作品に期待すること
当社はゴム素材を用いて、真に価値ある製品を提供する会社でありたいと考えています。

市場・ターゲットの動向
「好きなことを仕事にしたい」「やりがいや達成感を大切にしたい」と考えている就職・転職を考えている若年層がターゲットです。

課題商品・サービスの訴求したいポイント
ゴムは代替不可能な唯一の素材で、未来を創造する大きな可能性があることを表現してもらいたいです。""",
        height=200
    )
    
    generate_button = st.button("🚀 コピー生成", type="primary")

with col2:
    st.subheader("✨ 生成結果")
    
    if generate_button:
        if not orientation:
            st.error("オリエンテーションを入力してください")
        else:
            with st.spinner("コピーを生成中..."):
                result = generate_copy_ideas(orientation, 5)
                
            st.success("生成完了！")
            st.text_area("生成されたコピー", value=result, height=400)
            
            # ダウンロードボタン
            st.download_button(
                label="📄 結果をダウンロード",
                data=result,
                file_name="copy_ideas.txt",
                mime="text/plain"
            )

# サイドバー - 管理者用機能のみ
st.sidebar.header("🔧 管理者機能")
if st.sidebar.checkbox("管理者モード", value=False):
    st.sidebar.markdown("---")
    st.sidebar.subheader("管理者設定")
    
    if st.sidebar.button("サンプルデータ表示"):
        st.sidebar.json({
            "total_generations": 42,
            "avg_generation_time": "3.2秒"
        })
        
    # API設定確認
    if OPENAI_API_KEY == "sk-proj-your-api-key-here":
        st.sidebar.warning("⚠️ デフォルトAPIキーが設定されています")
    else:
        st.sidebar.success("✅ APIキーが設定済み") 